parameters:
  CmakeGeneratePath: ''
  Env: ''
  GenerateArgs: ''

steps:
  - script: mkdir build
    workingDirectory: ${{ parameters.CmakeGeneratePath }}
    displayName: create working directory

  - pwsh: Write-Host "ENVs - ${{ parameters.Env }} "
    workingDirectory: ${{ parameters.CmakeGeneratePath }}/build
    displayName: ENVs

  - script: pwd
    workingDirectory: ${{ parameters.CmakeGeneratePath }}/build
    displayName: Show current path

  - script: |
      ${{ parameters.Env }} cmake ${{ parameters.GenerateArgs }} ..
    workingDirectory: ${{ parameters.CmakeGeneratePath }}/build
    displayName: cmake generate
    env:
      VCPKG_BINARY_SOURCES: $(VCPKG_BINARY_SOURCES_SECRET)

  - task: PublishPipelineArtifact@1
    displayName: Publish build failure artifacts
    condition: failed()
    inputs:
      targetPath: ${{ parameters.CmakeGeneratePath }}/build
      artifact: build_failure_$(Agent.JobName)_$(System.JobAttempt)

  - script: rm -rf build
    workingDirectory: ${{ parameters.CmakeGeneratePath }}
    displayName: clean build folder
