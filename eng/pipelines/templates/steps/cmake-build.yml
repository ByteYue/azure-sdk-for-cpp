parameters:
  Env: ''
  GenerateArgs: ''
  Build: true
  BuildArgs: ''
  ServiceDirectory: ''


steps:
  - script: mkdir -p build
    displayName: create working directory

  - script: cmake --version
    workingDirectory: build
    displayName: cmake --version
  
  - script: |
      ${{ parameters.Env }} cmake -DINSTALL_GTEST=OFF -DBUILD_TESTING=OFF -DBUILD_PERFORMANCE_TESTS=OFF -DRUN_LONG_UNIT_TESTS=OFF ${{ parameters.GenerateArgs }} -DINSTALL_GTEST=OFF -DBUILD_TESTING=OFF -DBUILD_PERFORMANCE_TESTS=OFF -DRUN_LONG_UNIT_TESTS=OFF  ..
    workingDirectory: build
    displayName: cmake generate no test
    env:
      VCPKG_BINARY_SOURCES: $(VCPKG_BINARY_SOURCES_SECRET)
    condition: or(contains(parameters.GenerateArgs, "BUILD_TESTING"),contains(parameters.GenerateArgs, "BUILD_PERFORMANCE_TESTS"))

# Core should build all cmake tagets
  - ${{ if and(eq(parameters.Build, true), eq(parameters.ServiceDirectory, 'core')) }}:
    - script: cmake --build . ${{ parameters.BuildArgs }}
      workingDirectory: build
      displayName: cmake build All NO Test
      condition: or(contains(parameters.GenerateArgs, "BUILD_TESTING"),contains(parameters.GenerateArgs, "BUILD_PERFORMANCE_TESTS"))

# Non-core services define the list of targets to build
  - ${{ if and(eq(parameters.Build, true) , ne(parameters.ServiceDirectory, 'core')) }}:
    - pwsh: cmake --build . ${{ parameters.BuildArgs }} --target (Get-Content ${{ parameters.ServiceDirectory }}-targets-build.txt)
      workingDirectory: build
      displayName: cmake build Targets NO Test
      condition: or(contains(parameters.GenerateArgs, "BUILD_TESTING"),contains(parameters.GenerateArgs, "BUILD_PERFORMANCE_TESTS"))

  - script: |
      ${{ parameters.Env }} cmake ${{ parameters.GenerateArgs }} ..
    workingDirectory: build
    displayName: cmake generate
    env:
      VCPKG_BINARY_SOURCES: $(VCPKG_BINARY_SOURCES_SECRET)

# Core should build all cmake tagets
  - ${{ if and(eq(parameters.Build, true), eq(parameters.ServiceDirectory, 'core')) }}:
    - script: cmake --build . ${{ parameters.BuildArgs }}
      workingDirectory: build
      displayName: cmake build All

# Non-core services define the list of targets to build
  - ${{ if and(eq(parameters.Build, true) , ne(parameters.ServiceDirectory, 'core')) }}:
    - pwsh: cmake --build . ${{ parameters.BuildArgs }} --target (Get-Content ${{ parameters.ServiceDirectory }}-targets-build.txt)
      workingDirectory: build
      displayName: cmake build Targets

